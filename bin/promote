#!/usr/bin/env ruby
# vim: ft=ruby

require "cf_deployer/cli"
require "cf_deployer/command_runner"
require "cf_deployer/logger"
require "cf_deployer/release_repo"

cli = CfDeployer::Cli.new(ARGV)
options = cli.parse!
logger = CfDeployer::Logger.new(`tput cols`.to_i)

begin
  runner = CfDeployer::CommandRunner.new(logger, options.dry_run)

  repo = CfDeployer::ReleaseRepo.new(logger,
                                     runner,
                                     options.repos_path,
                                     options.release_repos[0],
                                     options.release_refs[0])

  repo.sync!
  repo.promote_dev_release(options.promote_branch)
rescue => e
  logger.log_exception e
  exit 1
end
